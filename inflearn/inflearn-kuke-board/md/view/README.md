## 섹션 5. 조회수

### 요구사항
- 조회수 어뷰징 방지 정책이 필요하다.
  - 각 사용자는 게시글 1개 당 10분에 1번 조회수 집계
  - 10분동안 100번 조회하더라도, 1번만 집계된다.

### 조회수 설계
- 조회수는 게시글이 조회된 횟수만 저장하면 된다.
  - 사용자는 내역을 확인하지 못하므로, 조회수만 보여주면 된다.
    - 전체 조회수를 단일 레코드에 비정규화 상태로 count만 저장해도 충분할 것
    - 좋아유 수, 게시글 수, 댓글 수처럼 다른 데이터의 개수로 파생되는 것이 아니다.

### 고려해볼 점
- 게시글/댓글/좋아요 수는 데이터의 일관성이 비교적 중요하다.
  - 원본 데이터를 통해 개수가 파생되므로, 이러한 불일치가 발생하면 안된다.
  - 불일치가 발생하면 사용자가 인지할 수 있다.
- 반면 조회수는 데이터의 일관성이 비교적 덜 중요하다.
  - 모든 조회 내역을 보여주지 않고 단순히 조회된 횟수만 보여주면 된다.
  - 가령 불일치가 발생하더라도 사용자가 인지하기 어렵다.

- 게시글/댓글/좋아요 수는 사용자의 직접적인 액션에 의해 쓰기 작업이 필요하기 때문에 쓰기 트래픽이 비교적 적다.
- 반면 조회수는 게시글 조회만 해도 쓰기 작업이 필요하기 때문에 쓰기 트래픽이 비교적 많다.


***조회수는 데이터 일관성이 덜 중요하고 다른 데이터에 의해 파생되는 데이터가 아니므로 트랜잭션이나 안전한 저장소가 반드시 필요하진 않는다.***

### In-Memory Database인 Redis를 사용하여 조회수 설계

### Redis
- In-memory Database
- NoSQL(Not Only SQL) Database
  - 관계형 데이터베이스와 달리 정해진 스키마가 없고, 유연한 데이터 모델 사용
- 키-값 저장소
- 다양한 자료 구조를 지원
- TTL(Time To Live) 지원
  - 일정 시간이 지나면 데이터 자동 삭제
- Single Thread
  - Redis는 단일 스레드에서 순차적으로 처리한다.
  - 각 명령어가 순차적으로 처리되므로, 동시성 문제를 해결하는데 유리하다.
- 데이터 백업 지원
  - 메모리는 휘발성 저장소지만, Redis에서 AOF, RDB와 같은 디스트에 저장하는 방법도 지원한다.
- Redis Cluster
  - 확장성, 부하 분산, 고가용성을 위한 분산 시스템 구성 방법 제공

### Redis 사용 사례
- 고성능 작업
  - 메모리는 상대적으로 빠르기 때문에, Redis 자체를 데이터베이스로 이용할 수 있다.
  - Single Thread로 동작하기 때문에, 동시성 문제를 다루는데 유리하다.
- 캐시
  - 더 느린 저장소에서 더 빠른 저장소에 데이터를 저장해두고 접근하는 기술 (Redis는 Cache로 사용될 수 있다.)
  - 매번 디스크에서 데이터를 접근하면 느리므로, Redis에 데이터를 일정 시간 캐시해둘 수 있다.
- pub/sub
  - Redis는 메시지 발행 및 구독할 수 있기 때문에 실시간 통신에도 활용할 수 있다.

### Redis Cluster
- Redis를 수평적으로 확장할 수 있게 해주는 기능
- 샤딩을 지원한다.
  - 확장성을 위해 논리적 샤드 (Logical Shard)를 지원한다. (16,384개의 Slot)
  - shard 선택 방식 (Physical Shard)
    - key의 hash 값으로 slot(Logical Shard)을 구하고, slot으로 shard(Physical Shard)를 선택한다.
      - slot = hash_function(key)
      - shard = select_shard(slot)
- 서버가 추가되면, 자동으로 데이터가 분산된다.
- 데이터 복제 기능을 제공한다. (고가용성)

### 백업
- Redis에는 디스크로의 데이터 백업을 위해, AOF와 RDB를 지원한다.
  - AOF
    - Append Only File
    - 수행된 명령어를 로그 파일에 기록하고, 데이터 복구를 위해 로그를 재실행한다.
  - RDB
    - Snapshot
    - 저장된 데이터를 주기적으로 파일에 저장한다.
- 강의 프로젝트에서는 백업 시스템도 직접 구축해본다.
  - 주 데이터베이스로 사용하던 MySQL에 데이터를 백업
  - 애플리케이션에서 Redis에 저장된 데이터를 MySQL에 직접 백업

### 백업시 고려해볼 점
- 백업은 약간의 데이터 유실은 허용한다는 관점이기 때문에 실시간으로 모든 데이터를 백업할 필요는 없다.
- 시간 단위 백업
  - N분 단위로 Redis의 데이터를 MySQL로 백업한다.
  - 배치 또는 스케줄링 시스템 구축 필요
  - 백업 전 장애 시에 유실될 수 있음
- 개수 단위 백업
  - N개 단위로 Redis의 데이터를 MySQL로 백업한다.
  - 조회 시점에 간단히 처리 가능
  - 백업 전 장애 시에 유실될 수 있음
  - 개수 단위가 채워지지 않으면 유실될 수 있음


### [조회수 DB, Table 설계](database_table_setting/README.md)

### [조회수 어뷰징 방지 정책 설계](avoid_abuse_policy/README.md)


#### 참고 링크
- [Redis 캐시로 몰려드는 트래픽을 견디다 — 토니모리 공식몰 성능 개선기](https://tonymoly-tech.medium.com/redis-cache-tonymoly-performance-c5a5e18ae83c)
- [\[NHN FORWARD 2021\] Redis 야무지게 사용하기](https://www.youtube.com/watch?v=92NizoBL4uA)
- [\[우아한테크세미나\] 191121 우아한레디스 by 강대명님](https://www.youtube.com/watch?v=mPB2CZiAkKM)