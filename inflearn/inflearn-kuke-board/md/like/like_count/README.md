### 좋아요 수 설계

#### 요구사항

- 좋아요 수는 전체 개수를 실시간으로 빠르게 보여줘야 한다.
- 조회 시점에 전체 개수를 실시간 조회하는게 큰 비용이 든다면
  - 좋아요가 생성/삭제될 때마다 미리 좋아요 수를 갱신하여 게시글 별 좋아요 개수를 미리 하나의 데이터로 비정규화 하는 방법이 있다.

#### 분석

- 좋아요 수는 쓰기 트래픽이 비교적 크지 않다.
  1. 사용자는 게시글을 조회하고 마음에 드는 게시글을 찾는다.
  2. 사용자는 좋아요 액션을 직접 수행한다.
- 데이터의 일관성의 비교적 중요하다.
  - 15명이 좋아요 했는데 좋아요 수는 10명으로 나오면 안된다.

- 쓰기 트래픽이 비교적 크지 않고, 일관성이 중요하다면
  - 관계형 데이터베이스의 트랜잭션을 활용해볼 수 있다.
  - 좋아요 테이블의 데이터 생성/삭제와 좋아요 수 갱신을 하나의 트랜잭션으로 묶는 것이다.
  - 데이터베이스는 좋아요 테이블고 동일한 MySQL을 사용한다.

### 적용 방법

- [case1] - 게시글 테이블의 컬럼으로 좋아요 수를 넣는 방법
  - 게시글 테이블에 좋아요 수 컬럼을 추가하고 좋아요가 생성/삭제될 때마다 좋아요 수를 갱신한다.
  - 좋아요 수는 게시글과 1:1 관계의 데이터이기 때문에 게시글 테이블에 비정규화 해도 크게 문제가 없다.
- 하지만 이 방법은 몇가지 제약이 있다. (Record Lock, 분산 트랜잭션)

##### Record Lock
- 레코드에 락을 거는 것
- 동일한 레코드에 동시에 조회 또는 수정할 때 데이터의 무결성 보장, 경쟁 상태 방지

- 참고 링크
  - [Lock Type](https://jaeseongdev.github.io/development/2021/06/16/Lock%EC%9D%98-%EC%A2%85%EB%A5%98-(Shared-Lock,-Exclusive-Lock,-Record-Lock,-Gap-Lock,-Next-key-Lock)/)

- 게시글과 좋아요는 LifeCycle이 다르다.
  - 게시글은,
    - 게시글을 작성한 사용자가 쓰기 작업을 수행한다.
    - 트래픽은 상대적으로 적다.
  - 좋아요 수는,
    - 게시글을 조회한 사용자들이 쓰기 작업을 수행한다.
    - 트래픽은 상대적으로 많다.

- 게시글 쓰기와 좋아요 수 쓰기는 사용자 입장에서 독립적으로 수행되는 기능인데 서로 다른 주체에 의해서 레코드에 락이 잡힐 수 있는 것이다.
  - ex) 작성자와 관계 없는 좋아요 수 갱신으로 인해 작성자의 쓰기 작업이 실패?
- 이러한 문제를 방지하기 위해 게시글과 좋아요 수의 변경은 독립적인 테이블로 분리할 수 있다.

##### 분산 트랜잭션
- Record Lock에서 살펴본 바와 같이 게시글 서비스에서 좋아요 수 테이블을 관리한다면
  - 분산 환경이기 때문에 트랜잭션 관리가 복잡해진다.
  - 그리고 개념상 좋아요 서비스가 이미 있는데, 게시글 서비스에서 관리할 이유가 없다.
- 따라서 좋아요 서비스에서 좋아요 수 테이블을 관리한다.

- 좋아요 테이블은 데이터의 적절한 분산을 위해 article_id를 Shard key로 사용하고 있다.
- 좋아요 수 테이블도 동일하게 article_id를 Shard key로 사용한다.

- 이제 좋아요의 생성/삭제에 따른 좋아요 수 갱신은
  - 단일 데이터베이스에서 하나의 트랜잭션으로 묶어서 처리가 가능하다.


#### 동시성 문제
- 하지만 지금은 동시성 문제가 발생할 수 있는 상황이기 때문에 높은 쓰기 트래픽이 발생하면 동시성 문제가 발생할 수 있다.
- 트랜잭션을 사용하더라도 동시성 무넺로 인해, 구현 방법에 따라 데이터의 일관성은 여전히 깨질 수 있다.
- 따라서 앞서 살펴본 Lock의 개념이 필요하다.

#### 해결 방안
- 해결 방안으로는 비관적 락, 낙관적 락, 비동기 순차 처리 방법이 있다.
- Record Lock은 비관적 락에 해당한다.
- 학습을 위해 비관적 락, 낙관적 락 방법을 구현해본다. (비동기 순차 처리는 인기글/게시글 조회 최적화에서 구현 예정)

### [비관적 락](pessimistic_lock/README.md)

### [낙관적 락](optimistic_lock/README.md)

### [비동기 순차 처리](async_sequential_processing/README.md)


### Table 생성
```shell
# 좋아요 수 테이블 생성
create table article_like_count (
    -> article_id bigint not null primary key,
    -> like_count bigint not null,
    -> version bigint not null
    -> );
```

- script는 `service/like/src/main/resources/db/rdb-schema.sql`에 위치